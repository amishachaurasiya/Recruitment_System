package com.coforge.employer.servlet;

import java.io.IOException;

import java.sql.Connection;

import java.sql.DriverManager;

import java.sql.PreparedStatement;

import java.sql.ResultSet;

import javax.servlet.ServletException;

import javax.servlet.annotation.WebServlet;

import javax.servlet.http.HttpServlet;

import javax.servlet.http.HttpServletRequest;

import javax.servlet.http.HttpServletResponse;

import javax.servlet.RequestDispatcher;



@WebServlet("/LoginServlet")

public class LoginServlet extends HttpServlet {

  private static final long serialVersionUID = 1L;



  protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

    String email = request.getParameter("email");

    boolean isEmailRegistered = checkEmailInDatabase(email);



    if (!isEmailRegistered) {

      // Email not found, show error message

      request.setAttribute("errorMessage", "Email is not registered. Please go to register.");

      RequestDispatcher dispatcher = request.getRequestDispatcher("login_index.jsp");

      dispatcher.forward(request, response);

    } else {

      response.sendRedirect("success.jsp");
      // Perform login logic if email is found

      // You can add password verification and other login processes here

      //response.sendRedirect("welcome.jsp"); // Redirect to a welcome page

    }

  }



  private boolean checkEmailInDatabase(String email) {

    boolean isRegistered = false;

    Connection connection = null;

    PreparedStatement preparedStatement = null;

    ResultSet resultSet = null;



    try {

      // Database connection setup (use your own credentials)

      Class.forName("com.mysql.cj.jdbc.Driver");

      connection = DriverManager.getConnection("jdbc:mysql://localhost:3306/recruitment", "root", "mysql");



      String query = "SELECT * FROM employer WHERE email = ?";

      preparedStatement = connection.prepareStatement(query);

      preparedStatement.setString(1, email);

      resultSet = preparedStatement.executeQuery();



      if (resultSet.next()) {

        isRegistered = true; // Email is found in the database

      }



    } catch (Exception e) {

      e.printStackTrace();

    } finally {

      // Close the database connections

      try { if (resultSet != null) resultSet.close(); } catch (Exception e) { e.printStackTrace(); }

      try { if (preparedStatement != null) preparedStatement.close(); } catch (Exception e) { e.printStackTrace(); }

      try { if (connection != null) connection.close(); } catch (Exception e) { e.printStackTrace(); }

    }



    return isRegistered;

  }

}
